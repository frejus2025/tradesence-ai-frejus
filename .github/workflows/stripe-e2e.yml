name: Stripe E2E Tests
on:
  workflow_dispatch:
  push:
    branches: [ add-ci-workflows, main ]

jobs:
  stripe-e2e:
    name: Stripe E2E
    runs-on: ubuntu-latest
    env:
      GCP_PROJECT: ${{ secrets.STAGING_PROJECT_ID }}
      STRIPE_KEY: ${{ secrets.STRIPE_TEST_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.STAGING_PROJECT_ID }}

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Stripe CLI
        run: |
          curl -sS https://stripe-cli-apt.s3.amazonaws.com/stripe-cli-apt-key.gpg | sudo apt-key add -
          echo "deb https://stripe-cli-apt.s3.amazonaws.com/ stable main" | sudo tee /etc/apt/sources.list.d/stripe-cli.list
          sudo apt-get update && sudo apt-get install -y stripe

      - name: Resolve staging service URL
        id: resolve_url
        run: |
          SERVICE_NAME=$(gcloud run services list --platform=managed --project="${{ secrets.STAGING_PROJECT_ID }}" --format="value(metadata.name)" --limit=1)
          if [ -z "$SERVICE_NAME" ]; then
            echo "No Cloud Run service found in project ${GCP_PROJECT}"
            exit 1
          fi
          URL=$(gcloud run services describe "$SERVICE_NAME" --platform=managed --project="${{ secrets.STAGING_PROJECT_ID }}" --format="value(status.url)")
          echo "service_url=$URL" >> $GITHUB_OUTPUT

      - name: Run Stripe CLI webhook test
        env:
          STRIPE_TEST_KEY: ${{ secrets.STRIPE_TEST_KEY }}
        run: |
          echo "Testing Stripe webhooks against ${{ steps.resolve_url.outputs.service_url }}"
          stripe listen --forward-to "${{ steps.resolve_url.outputs.service_url }}/api/webhook" --api-key "${STRIPE_TEST_KEY}" &
          LISTEN_PID=$!
          sleep 3
          stripe trigger payment_intent.succeeded --api-key "${STRIPE_TEST_KEY}"
          sleep 5
          kill $LISTEN_PID || true
